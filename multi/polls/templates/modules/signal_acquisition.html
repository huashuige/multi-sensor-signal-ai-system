{% extends 'modules/module_base.html' %}

{% block module_content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
    <!-- é¡¶éƒ¨å‚æ•°é…ç½®åŒºåŸŸ - æ¢å¤v20å¸ƒå±€ä½†åŠ å®½å®¹å™¨ -->
    <div class="max-w-6xl mx-auto bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl border border-white/20 mb-6">
        <div class="grid grid-cols-12 gap-6">

            <!-- è®¾å¤‡è¿æ¥ -->
            <div class="col-span-2">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div id="statusIndicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span id="statusText" class="text-sm font-medium text-gray-700">è®¾å¤‡æœªè¿æ¥</span>
                    </div>
                    <div id="acquisitionStatus" class="hidden">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        è¿æ¥
                    </button>
                    <button id="disconnectBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50" disabled>
                        æ–­å¼€
                    </button>
                </div>
            </div>

            <!-- é‡‡é›†æ¨¡å¼ -->
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">é‡‡é›†æ¨¡å¼</label>
                <select id="acquisitionMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                    <option value="0">è¿ç»­é‡‡é›†</option>
                    <option value="1">å•æ¬¡é‡‡é›†</option>
                </select>
            </div>

            <!-- é‡‡æ ·ç‡ - æ”¯æŒæ‰‹åŠ¨è¾“å…¥ -->
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">é‡‡æ ·ç‡ (Hz)</label>
                <input type="number" id="sampleRate" value="10000" min="100" max="1000000" step="100" list="sampleRateOptions"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                       placeholder="è¾“å…¥æˆ–é€‰æ‹©é‡‡æ ·ç‡">
                <datalist id="sampleRateOptions">
                    <option value="1000">1 kHz</option>
                    <option value="10000">10 kHz</option>
                    <option value="50000">50 kHz</option>
                    <option value="100000">100 kHz</option>
                    <option value="200000">200 kHz</option>
                    <option value="500000">500 kHz</option>
                </datalist>
            </div>

            <!-- å•æ¬¡é‡‡é›†ç‚¹æ•° -->
            <div class="col-span-2" id="oneshotPointsDiv">
                <label class="block text-sm font-medium text-gray-700 mb-2">é‡‡é›†ç‚¹æ•°</label>
                <input type="number" id="oneshotPoints" value="1000" min="100" max="10000" step="100"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>

            <!-- é€šé“é…ç½®æŒ‰é’® -->
            <div class="col-span-2 flex items-end">
                <button id="openChannelConfig" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50" disabled>
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                        </svg>
                        <span>é€šé“é…ç½®</span>
                    </div>
                </button>
            </div>

            <!-- æ˜¾ç¤ºå•ä½ -->
            <div class="col-span-2 flex items-end">
                <div class="w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ˜¾ç¤ºå•ä½</label>
                    <select id="displayUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="voltage">ç”µå‹(V)</option>
                        <option value="converted">è½¬æ¢å€¼(A)</option>
                    </select>
                </div>
            </div>

        </div>

        <!-- ç¬¬äºŒè¡Œï¼šé…ç½®æŒ‰é’®å’ŒçŠ¶æ€ä¿¡æ¯ -->
        <div class="grid grid-cols-12 gap-6 mt-4">
            <div class="col-span-3">
                <button id="applyConfig" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50" disabled>
                    åº”ç”¨é…ç½®
                </button>
            </div>
            <div class="col-span-3">
                <div class="text-sm text-gray-600 space-y-1">
                    <div>ç¼“å†²åŒº: <span id="bufferRemaining" class="font-mono text-blue-600">0</span></div>
                    <div>é€Ÿç‡: <span id="acquisitionRate" class="font-mono text-green-600">0 Hz</span></div>
                </div>
            </div>
            <div class="col-span-6">
                <div class="text-sm text-gray-600">
                    å½“å‰æ˜¾ç¤º: <span id="currentUnit" class="font-semibold text-blue-600">ç”µå‹ (V)</span>
                    <span id="enabledChannelsInfo" class="ml-4 text-gray-500">å·²å¯ç”¨: 0ä¸ªé€šé“</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¤ºæ³¢å™¨æ³¢å½¢æ˜¾ç¤ºåŒºåŸŸ - é™ä½é«˜åº¦ -->
    <div class="max-w-6xl mx-auto bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl border border-white/20 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                æ•°å­—ç¤ºæ³¢å™¨
            </h3>
            <div class="flex items-center space-x-2" id="channelLegend">
                <!-- åŠ¨æ€ç”Ÿæˆé€šé“å›¾ä¾‹ -->
            </div>
        </div>

        <!-- ç¤ºæ³¢å™¨æ˜¾ç¤ºå± - é™ä½é«˜åº¦åˆ°450px -->
        <div class="bg-black rounded-xl p-4 border-4 border-gray-800 shadow-inner">
            <div id="realtimeChart" class="w-full rounded-lg" style="height: 450px;"></div>
        </div>

        <!-- é‡‡é›†æ§åˆ¶æŒ‰é’® - æ·»åŠ æ•°æ®å­˜å‚¨æŒ‰é’® -->
        <div class="flex justify-center space-x-6 mt-8">
            <button id="startAcquisition" class="bg-green-600 hover:bg-green-700 text-white px-10 py-4 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center space-x-3 shadow-lg" disabled>
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                </svg>
                <span>å¼€å§‹é‡‡é›†</span>
            </button>
            <button id="stopAcquisition" class="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center space-x-3 shadow-lg" disabled>
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                </svg>
                <span>åœæ­¢é‡‡é›†</span>
            </button>
            <!-- æ•°æ®å­˜å‚¨æŒ‰é’® -->
            <button id="saveData" class="bg-purple-600 hover:bg-purple-700 text-white px-10 py-4 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center space-x-3 shadow-lg">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span>æ•°æ®å­˜å‚¨</span>
            </button>
        </div>
    </div>

    <!-- è¿”å›æŒ‰é’® -->
    <div class="max-w-6xl mx-auto text-center">
        <a href="{% url 'all_acquire' %}" class="inline-flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-8 rounded-xl transition-colors duration-200 shadow-lg">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
            </svg>
            <span>è¿”å›ä¿¡å·é‡‡é›†æ¨¡å—</span>
        </a>
    </div>
</div>

<!-- 16é€šé“é…ç½®å¼¹çª— -->
<div id="channelConfigModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
        <!-- å¼¹çª—å¤´éƒ¨ -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold">16é€šé“é…ç½®</h2>
                <button id="closeChannelConfig" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <p class="text-purple-100 mt-2">é…ç½®æ¯ä¸ªé€šé“çš„é‡ç¨‹å’Œçµæ•åº¦</p>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <div class="p-6 overflow-y-auto max-h-[60vh]">
            <div class="grid grid-cols-4 gap-4" id="channelConfigGrid">
                <!-- åŠ¨æ€ç”Ÿæˆ16ä¸ªé€šé“é…ç½® -->
            </div>
        </div>

        <!-- å¼¹çª—åº•éƒ¨æŒ‰é’® -->
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-4">
            <button id="cancelChannelConfig" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                å–æ¶ˆ
            </button>
            <button id="confirmChannelConfig" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                ç¡®è®¤é…ç½®
            </button>
        </div>
    </div>
</div>

<!-- Toasté€šçŸ¥ -->
<div id="messageToast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toastIcon" class="mr-3"></div>
            <div>
                <div id="toastTitle" class="font-medium text-gray-900"></div>
                <div id="toastMessage" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>
</div>

{% load static %}
<script src="{% static 'js/echarts.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // WebSocketè¿æ¥
    let socket = null;
    let isConnected = false;
    let isAcquiring = false;
    let dataPacketCount = 0;

    // å›¾è¡¨å®ä¾‹
    let realtimeChart = null;
    let chartData = { time: [], ch0: [], ch1: [], ch2: [], ch3: [], ch4: [], ch5: [], ch6: [], ch7: [], ch8: [], ch9: [], ch10: [], ch11: [], ch12: [], ch13: [], ch14: [], ch15: [] };
    let maxDataPoints = 1000;

    // é€šé“é…ç½®
    let channelConfigs = {};
    let enabledChannels = [];

    // é€šé“é¢œè‰²é…ç½®
    const channelColors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316',
        '#ec4899', '#14b8a6', '#fbbf24', '#a855f7', '#06b6d4', '#84cc16', '#f97316', '#ec4899'
    ];

    // DOMå…ƒç´ 
    const elements = {
        statusIndicator: document.getElementById('statusIndicator'),
        statusText: document.getElementById('statusText'),
        acquisitionStatus: document.getElementById('acquisitionStatus'),
        connectBtn: document.getElementById('connectBtn'),
        disconnectBtn: document.getElementById('disconnectBtn'),
        openChannelConfig: document.getElementById('openChannelConfig'),
        channelConfigModal: document.getElementById('channelConfigModal'),
        closeChannelConfig: document.getElementById('closeChannelConfig'),
        cancelChannelConfig: document.getElementById('cancelChannelConfig'),
        confirmChannelConfig: document.getElementById('confirmChannelConfig'),
        channelConfigGrid: document.getElementById('channelConfigGrid'),
        channelLegend: document.getElementById('channelLegend'),
        acquisitionMode: document.getElementById('acquisitionMode'),
        sampleRate: document.getElementById('sampleRate'),
        oneshotPoints: document.getElementById('oneshotPoints'),
        oneshotPointsDiv: document.getElementById('oneshotPointsDiv'),
        displayUnit: document.getElementById('displayUnit'),
        currentUnit: document.getElementById('currentUnit'),
        enabledChannelsInfo: document.getElementById('enabledChannelsInfo'),
        applyConfig: document.getElementById('applyConfig'),
        startAcquisition: document.getElementById('startAcquisition'),
        stopAcquisition: document.getElementById('stopAcquisition'),
        saveData: document.getElementById('saveData'),
        bufferRemaining: document.getElementById('bufferRemaining'),
        acquisitionRate: document.getElementById('acquisitionRate')
    };

    // åˆå§‹åŒ–
    initializeUI();
    initializeChart();
    generateChannelConfigModal();

    function initializeUI() {
        bindEvents();
        updateDisplayUnit();
    }

    function generateChannelConfigModal() {
        const container = elements.channelConfigGrid;
        container.innerHTML = '';

        for (let i = 0; i < 16; i++) {
            const channelDiv = document.createElement('div');
            channelDiv.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-blue-300 transition-colors';
            channelDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="modalChannel${i}Enable" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <label class="text-sm font-bold text-gray-800">CH${i}</label>
                            <div class="w-3 h-3 rounded-full" style="background-color: ${channelColors[i]}"></div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">é‡ç¨‹ (V)</label>
                        <select id="modalChannel${i}Range" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="1">Â±1V</option>
                            <option value="2">Â±2V</option>
                            <option value="5">Â±5V</option>
                            <option value="10" selected>Â±10V</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">çµæ•åº¦ (A/V)</label>
                        <div class="flex space-x-1">
                            <input type="number" id="modalChannel${i}Sensitivity" value="1" min="0.1" max="10000" step="0.1"
                                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="è¾“å…¥æ•°å€¼">
                            <select id="modalChannel${i}SensitivityPreset" class="px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                                <option value="1">1</option>
                                <option value="10">10</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(channelDiv);

            // ç»‘å®šé¢„è®¾å€¼é€‰æ‹©äº‹ä»¶
            const presetSelect = document.getElementById(`modalChannel${i}SensitivityPreset`);
            const sensitivityInput = document.getElementById(`modalChannel${i}Sensitivity`);
            presetSelect.addEventListener('change', function() {
                sensitivityInput.value = this.value;
            });
        }
    }

    function bindEvents() {
        elements.connectBtn.addEventListener('click', connectDevice);
        elements.disconnectBtn.addEventListener('click', disconnectDevice);
        elements.openChannelConfig.addEventListener('click', openChannelConfigModal);
        elements.closeChannelConfig.addEventListener('click', closeChannelConfigModal);
        elements.cancelChannelConfig.addEventListener('click', closeChannelConfigModal);
        elements.confirmChannelConfig.addEventListener('click', confirmChannelConfiguration);
        elements.applyConfig.addEventListener('click', applyAcquisitionConfiguration);
        elements.startAcquisition.addEventListener('click', startAcquisition);
        elements.stopAcquisition.addEventListener('click', stopAcquisition);
        elements.saveData.addEventListener('click', saveData);

        // é‡‡é›†æ¨¡å¼å˜åŒ–
        elements.acquisitionMode.addEventListener('change', function() {
            const isOneshot = this.value === '1';
            elements.oneshotPointsDiv.style.display = isOneshot ? 'block' : 'none';
        });

        // æ˜¾ç¤ºå•ä½å˜åŒ–
        elements.displayUnit.addEventListener('change', updateDisplayUnit);

        // é‡‡æ ·ç‡è¾“å…¥éªŒè¯
        elements.sampleRate.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 100) this.value = 100;
            if (value > 1000000) this.value = 1000000;
        });
    }

    function openChannelConfigModal() {
        elements.channelConfigModal.classList.remove('hidden');
        // åŠ è½½å½“å‰é…ç½®
        loadCurrentChannelConfig();
    }

    function closeChannelConfigModal() {
        elements.channelConfigModal.classList.add('hidden');
    }

    function loadCurrentChannelConfig() {
        // åŠ è½½å½“å‰å·²ä¿å­˜çš„é€šé“é…ç½®
        for (let i = 0; i < 16; i++) {
            const config = channelConfigs[i] || { enabled: false, range: 10, sensitivity: 1 };
            
            document.getElementById(`modalChannel${i}Enable`).checked = config.enabled;
            document.getElementById(`modalChannel${i}Range`).value = config.range;
            document.getElementById(`modalChannel${i}Sensitivity`).value = config.sensitivity;
            
            // è®¾ç½®é¢„è®¾å€¼
            const presetSelect = document.getElementById(`modalChannel${i}SensitivityPreset`);
            if (config.sensitivity === 1) presetSelect.value = '1';
            else if (config.sensitivity === 10) presetSelect.value = '10';
            else if (config.sensitivity === 100) presetSelect.value = '100';
            else presetSelect.value = '1';
        }
    }

    function confirmChannelConfiguration() {
        // æ”¶é›†æ‰€æœ‰é€šé“é…ç½®
        const channels = [];
        enabledChannels = [];

        for (let i = 0; i < 16; i++) {
            const enabled = document.getElementById(`modalChannel${i}Enable`).checked;
            const range = parseFloat(document.getElementById(`modalChannel${i}Range`).value);
            const sensitivity = parseFloat(document.getElementById(`modalChannel${i}Sensitivity`).value);

            channelConfigs[i] = {
                enabled: enabled,
                range: range,
                sensitivity: sensitivity
            };

            if (enabled) {
                enabledChannels.push(i);
                channels.push({
                    channel: i,
                    enabled: enabled,
                    range: range
                });
            }
        }

        console.log('âš™ï¸ é€šé“é…ç½®:', channelConfigs);
        console.log('âœ… å¯ç”¨çš„é€šé“:', enabledChannels);

        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
        updateChannelLegend();
        updateEnabledChannelsInfo();

        // å‘é€é…ç½®åˆ°åç«¯
        sendMessage({
            type: 'configure_channels',
            channels: channels
        });

        // å…³é—­å¼¹çª—
        closeChannelConfigModal();
    }

    function updateChannelLegend() {
        const container = elements.channelLegend;
        container.innerHTML = '';

        enabledChannels.forEach(ch => {
            const legendDiv = document.createElement('div');
            legendDiv.className = 'flex items-center space-x-2 px-3 py-1 rounded-full';
            legendDiv.style.backgroundColor = `${channelColors[ch]}20`;
            legendDiv.innerHTML = `
                <div class="w-3 h-1 rounded" style="background-color: ${channelColors[ch]}"></div>
                <span class="text-xs font-medium" style="color: ${channelColors[ch]}">CH${ch}</span>
            `;
            container.appendChild(legendDiv);
        });
    }

    function updateEnabledChannelsInfo() {
        const count = enabledChannels.length;
        elements.enabledChannelsInfo.textContent = `å·²å¯ç”¨: ${count}ä¸ªé€šé“`;
        
        if (count > 0) {
            elements.startAcquisition.disabled = false;
        } else {
            elements.startAcquisition.disabled = true;
        }
    }

    function updateDisplayUnit() {
        const unit = elements.displayUnit.value;
        if (unit === 'voltage') {
            elements.currentUnit.textContent = 'ç”µå‹ (V)';
        } else {
            elements.currentUnit.textContent = 'è½¬æ¢å€¼ (A)';
        }

        // æ›´æ–°å›¾è¡¨Yè½´
        if (realtimeChart) {
            updateChartYAxis();
        }
    }

    function updateChartYAxis() {
        const unit = elements.displayUnit.value;
        let yAxisName, yAxisMin, yAxisMax;

        if (unit === 'voltage') {
            yAxisName = 'ç”µå‹ (V)';
            yAxisMin = -10;
            yAxisMax = 10;
        } else {
            yAxisName = 'è½¬æ¢å€¼ (A)';
            yAxisMin = -10;
            yAxisMax = 10;
        }

        realtimeChart.setOption({
            yAxis: {
                name: yAxisName,
                min: yAxisMin,
                max: yAxisMax
            }
        });
    }

    function initializeChart() {
        realtimeChart = echarts.init(document.getElementById('realtimeChart'));

        const option = {
            backgroundColor: '#000000',
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                borderColor: '#00ff00',
                textStyle: { color: '#00ff00', fontFamily: 'monospace' },
                formatter: function(params) {
                    let result = `æ—¶é—´: ${parseFloat(params[0].axisValueLabel).toFixed(4)}s<br/>`;
                    params.forEach(param => {
                        if (param.value !== null && param.value !== undefined) {
                            const unit = elements.displayUnit.value === 'voltage' ? 'V' : 'A';
                            result += `${param.seriesName}: ${parseFloat(param.value).toFixed(4)}${unit}<br/>`;
                        }
                    });
                    return result;
                }
            },
            legend: {
                top: 15,
                textStyle: { color: '#00ff00', fontFamily: 'monospace', fontSize: 12 }
            },
            xAxis: {
                type: 'category',
                name: 'æ—¶é—´ (s)',
                nameTextStyle: { color: '#00ff00', fontFamily: 'monospace' },
                axisLine: { lineStyle: { color: '#00ff00', width: 2 } },
                axisTick: { lineStyle: { color: '#00ff00', width: 1 } },
                axisLabel: {
                    color: '#00ff00',
                    fontFamily: 'monospace',
                    fontSize: 10,
                    formatter: function(value) {
                        return parseFloat(value).toFixed(3);
                    }
                },
                splitLine: {
                    show: true,
                    lineStyle: { color: '#003300', width: 1, type: 'solid' }
                },
                minorSplitLine: {
                    show: true,
                    lineStyle: { color: '#001100', width: 0.5, type: 'solid' }
                },
                data: []
            },
            yAxis: {
                type: 'value',
                name: 'ç”µå‹ (V)',
                nameTextStyle: { color: '#00ff00', fontFamily: 'monospace' },
                axisLine: { lineStyle: { color: '#00ff00', width: 2 } },
                axisTick: { lineStyle: { color: '#00ff00', width: 1 } },
                axisLabel: {
                    color: '#00ff00',
                    fontFamily: 'monospace',
                    fontSize: 10,
                    formatter: function(value) {
                        return value.toFixed(2);
                    }
                },
                splitLine: {
                    show: true,
                    lineStyle: { color: '#003300', width: 1, type: 'solid' }
                },
                minorSplitLine: {
                    show: true,
                    lineStyle: { color: '#001100', width: 0.5, type: 'solid' }
                },
                min: -10,
                max: 10
            },
            series: [],
            grid: {
                left: '8%',
                right: '5%',
                bottom: '15%',
                top: '15%',
                borderColor: '#00ff00',
                borderWidth: 2
            },
            animation: false,
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    filterMode: 'none'
                },
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    bottom: 30,
                    height: 20,
                    backgroundColor: '#001100',
                    borderColor: '#00ff00',
                    fillerColor: 'rgba(0, 255, 0, 0.2)',
                    handleStyle: { color: '#00ff00' },
                    textStyle: { color: '#00ff00', fontFamily: 'monospace' }
                }
            ]
        };

        realtimeChart.setOption(option);
    }

    function connectDevice() {
        if (socket) socket.close();

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/signal-acquisition/`;

        console.log('ğŸ”Œ æ­£åœ¨è¿æ¥WebSocket:', wsUrl);

        socket = new WebSocket(wsUrl);

        socket.onopen = function(event) {
            console.log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
            sendMessage({ type: 'open_device' });
        };

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        };

        socket.onclose = function(event) {
            console.log('âŒ WebSocketè¿æ¥å·²å…³é—­');
            updateConnectionStatus(false);
        };

        socket.onerror = function(error) {
            console.error('ğŸš¨ WebSocketé”™è¯¯:', error);
            showToast('error', 'è¿æ¥é”™è¯¯', 'WebSocketè¿æ¥å¤±è´¥');
        };
    }

    function disconnectDevice() {
        if (socket) {
            sendMessage({ type: 'close_device' });
            socket.close();
        }
    }

    function sendMessage(message) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(message));
            console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', message);
        }
    }

    function handleWebSocketMessage(message) {
        console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:', message);

        switch (message.type) {
            case 'success':
                if (message.message.includes('è®¾å¤‡æ‰“å¼€æˆåŠŸ')) {
                    updateConnectionStatus(true);
                }
                showToast('success', 'æˆåŠŸ', message.message);
                break;

            case 'error':
                showToast('error', 'é”™è¯¯', message.message);
                break;

            case 'configure_channels_result':
                handleChannelConfigResult(message.data);
                break;

            case 'device_status':
                updateDeviceStatus(message.data);
                break;

            case 'acquisition_data':
                handleAcquisitionData(message.data);
                break;
        }
    }

    function updateConnectionStatus(connected) {
        isConnected = connected;

        if (connected) {
            elements.statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
            elements.statusText.textContent = 'è®¾å¤‡å·²è¿æ¥';
            elements.connectBtn.disabled = true;
            elements.disconnectBtn.disabled = false;
            elements.openChannelConfig.disabled = false;
            elements.applyConfig.disabled = false;
            console.log('âœ… è®¾å¤‡è¿æ¥çŠ¶æ€: å·²è¿æ¥');
        } else {
            elements.statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
            elements.statusText.textContent = 'è®¾å¤‡æœªè¿æ¥';
            elements.connectBtn.disabled = false;
            elements.disconnectBtn.disabled = true;
            elements.openChannelConfig.disabled = true;
            elements.applyConfig.disabled = true;
            elements.startAcquisition.disabled = true;
            elements.stopAcquisition.disabled = true;
            console.log('âŒ è®¾å¤‡è¿æ¥çŠ¶æ€: æœªè¿æ¥');

            if (isAcquiring) {
                updateAcquisitionStatus(false);
            }
        }
    }

    function updateAcquisitionStatus(acquiring) {
        isAcquiring = acquiring;

        if (acquiring) {
            elements.acquisitionStatus.classList.remove('hidden');
            elements.startAcquisition.disabled = true;
            elements.stopAcquisition.disabled = false;
            dataPacketCount = 0;
            console.log('ğŸ¯ é‡‡é›†çŠ¶æ€: å¼€å§‹é‡‡é›†');
        } else {
            elements.acquisitionStatus.classList.add('hidden');
            elements.startAcquisition.disabled = !isConnected || enabledChannels.length === 0;
            elements.stopAcquisition.disabled = true;
            console.log('â¹ï¸ é‡‡é›†çŠ¶æ€: åœæ­¢é‡‡é›†');
            if (dataPacketCount > 0) {
                console.log(`ğŸ“Š æœ¬æ¬¡é‡‡é›†ç»Ÿè®¡: å…±æ¥æ”¶ ${dataPacketCount} ä¸ªæ•°æ®åŒ…`);
            }
        }
    }

    function applyAcquisitionConfiguration() {
        const config = {
            mode: parseInt(elements.acquisitionMode.value),
            sample_rate: parseInt(elements.sampleRate.value),
            oneshot_points: parseInt(elements.oneshotPoints.value)
        };

        console.log('âš™ï¸ åº”ç”¨é‡‡é›†é…ç½®:', config);
        sendMessage({
            type: 'configure_acquisition',
            config: config
        });
    }

    function startAcquisition() {
        console.log('ğŸš€ å¼€å§‹æ•°æ®é‡‡é›†...');
        sendMessage({ type: 'start_acquisition' });
        updateAcquisitionStatus(true);

        // æ¸…ç©ºå›¾è¡¨æ•°æ®
        chartData = { time: [], ch0: [], ch1: [], ch2: [], ch3: [], ch4: [], ch5: [], ch6: [], ch7: [], ch8: [], ch9: [], ch10: [], ch11: [], ch12: [], ch13: [], ch14: [], ch15: [] };
    }

    function stopAcquisition() {
        console.log('â¹ï¸ åœæ­¢æ•°æ®é‡‡é›†...');
        sendMessage({ type: 'stop_acquisition' });
        updateAcquisitionStatus(false);
    }

    function saveData() {
        console.log('ğŸ’¾ æ•°æ®å­˜å‚¨åŠŸèƒ½');

        // è·å–å½“å‰é…ç½®ä¿¡æ¯
        const config = {
            sampleRate: elements.sampleRate.value,
            displayUnit: elements.displayUnit.value,
            acquisitionMode: elements.acquisitionMode.value,
            dataPackets: dataPacketCount,
            channelConfigs: channelConfigs,
            enabledChannels: enabledChannels,
            timestamp: new Date().toISOString()
        };

        console.log('ğŸ“‹ å­˜å‚¨é…ç½®:', config);

        // æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨
        showToast('success', 'æ•°æ®å­˜å‚¨', `å·²ä¿å­˜ ${dataPacketCount} ä¸ªæ•°æ®åŒ…çš„é…ç½®ä¿¡æ¯`);

        // è¿™é‡ŒåæœŸå¯ä»¥æ·»åŠ å®é™…çš„æ•°æ®å­˜å‚¨é€»è¾‘
        // æ¯”å¦‚å‘é€åˆ°åç«¯APIæˆ–ä¸‹è½½æ–‡ä»¶ç­‰
    }

    function handleChannelConfigResult(data) {
        const results = data.results;
        let successCount = 0;

        results.forEach(result => {
            if (result.success) {
                successCount++;
            }
        });

        console.log(`âœ… é€šé“é…ç½®ç»“æœ: ${successCount}/${results.length} ä¸ªé€šé“é…ç½®æˆåŠŸ`);

        if (successCount > 0) {
            elements.startAcquisition.disabled = false;
        }
    }

    function handleAcquisitionData(data) {
        dataPacketCount++;

        // æ³¨æ„ï¼šåç«¯ Points å‚æ•°ä¸ºæ¯é€šé“ç‚¹æ•°ï¼Œchannel_data ç»“æ„ä¸º {é€šé“å·: [ç‚¹...]}ï¼Œenabled_channels é¡ºåºä¸åç«¯ä¸€è‡´

        // è¯¦ç»†çš„æœ¬åœ°æ—¥å¿—
        const enabledChannels = data.enabled_channels || [];
        const pointsPerChannel = data.points_per_channel || 0;
        const sampleRate = data.sample_rate || 0;
        const remainingPoints = data.remaining_points || 0;
        const channelData = data.channel_data || {};

        console.log(`ğŸ“¦ æ•°æ®åŒ… #${dataPacketCount}:`);
        console.log(`   å¯ç”¨é€šé“: [${enabledChannels.join(', ')}]`);
        console.log(`   æ¯é€šé“ç‚¹æ•°: ${pointsPerChannel}`);
        console.log(`   é‡‡æ ·ç‡: ${sampleRate} Hz`);
        console.log(`   ç¼“å†²åŒºå‰©ä½™: ${remainingPoints} ç‚¹`);

        // è·å–å½“å‰è®¾ç½®
        const displayUnit = elements.displayUnit.value;

        // è®°å½•æ¯ä¸ªé€šé“çš„æ•°æ®ç»Ÿè®¡
        enabledChannels.forEach(ch => {
            const chData = channelData[ch.toString()];
            if (chData && chData.length > 0) {
                const voltageData = chData;
                const config = channelConfigs[ch] || { sensitivity: 1 };
                const convertedData = voltageData.map(v => v * config.sensitivity);

                const vMin = Math.min(...voltageData);
                const vMax = Math.max(...voltageData);
                const vAvg = voltageData.reduce((a, b) => a + b, 0) / voltageData.length;
                const vRms = Math.sqrt(voltageData.reduce((a, b) => a + b*b, 0) / voltageData.length);

                const cMin = Math.min(...convertedData);
                const cMax = Math.max(...convertedData);
                const cAvg = convertedData.reduce((a, b) => a + b, 0) / convertedData.length;
                const cRms = Math.sqrt(convertedData.reduce((a, b) => a + b*b, 0) / convertedData.length);

                console.log(`   CH${ch} ç”µå‹: æœ€å°=${vMin.toFixed(4)}V, æœ€å¤§=${vMax.toFixed(4)}V, å¹³å‡=${vAvg.toFixed(4)}V, RMS=${vRms.toFixed(4)}V`);
                console.log(`   CH${ch} è½¬æ¢å€¼: æœ€å°=${cMin.toFixed(2)}A, æœ€å¤§=${cMax.toFixed(2)}A, å¹³å‡=${cAvg.toFixed(2)}A, RMS=${cRms.toFixed(2)}A`);
            }
        });

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        elements.bufferRemaining.textContent = remainingPoints;
        elements.acquisitionRate.textContent = sampleRate;

        // æ›´æ–°å›¾è¡¨æ•°æ®
        updateChart(data);
    }

    function updateChart(data) {
        // 1. å–å‡ºæ•°æ®
        const timeAxis = data.time_axis;
        const channelData = data.channel_data;
        const enabledChannels = data.enabled_channels;
        const displayUnit = elements.displayUnit.value;

        // 2. è°ƒè¯•æ—¥å¿—
        console.log('ğŸ“Š æ›´æ–°å›¾è¡¨æ•°æ®:', {
            timeAxisLength: timeAxis.length,
            timeAxisFirst5: timeAxis.slice(0, 5),
            enabledChannels: enabledChannels,
            channelDataKeys: Object.keys(channelData)
        });

        // 3. æ—¶é—´è½´å¥å£®æ€§æ£€æŸ¥ä¸ç¾åŒ–
        let timeLabels = Array.isArray(timeAxis) ? timeAxis.map(t => Number(t).toFixed(4)) : [];
        if (timeLabels.length === 0) {
            console.error('âŒ æ—¶é—´è½´æ•°æ®å¼‚å¸¸:', timeAxis);
            return;
        }

        // 4. æ„é€  seriesData
        const series = enabledChannels.map((ch, idx) => {
            let chData = channelData[ch.toString()] || [];
            if (displayUnit !== 'voltage') {
                const config = channelConfigs[ch] || { sensitivity: 1 };
                chData = chData.map(v => v * config.sensitivity);
            }
            return {
                name: `CH${ch}`,
                type: 'line',
                showSymbol: false,
                data: chData,
                lineStyle: { color: channelColors[ch], width: 2 },
                sampling: 'lttb'
            };
        });

        // 5. æ‰“å° option è°ƒè¯•
        console.log('ğŸ“ˆ å›¾è¡¨é…ç½®:', {
            timeLabelsLength: timeLabels.length,
            timeLabelsFirst5: timeLabels.slice(0, 5),
            seriesCount: series.length
        });

        // 6. æ›´æ–°å›¾è¡¨
        const option = {
            xAxis: {
                type: 'category',
                data: timeLabels,
                axisLabel: {
                    formatter: function(value) { return value; }
                }
            },
            series: series
        };
        realtimeChart.setOption(option);
        console.log('âœ… å›¾è¡¨æ›´æ–°å®Œæˆ');
    }

    function showToast(type, title, message) {
        const toast = document.getElementById('messageToast');
        const icon = document.getElementById('toastIcon');
        const titleEl = document.getElementById('toastTitle');
        const messageEl = document.getElementById('toastMessage');

        if (type === 'success') {
            icon.innerHTML = '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><div class="w-3 h-3 bg-green-500 rounded-full"></div></div>';
        } else {
            icon.innerHTML = '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><div class="w-3 h-3 bg-red-500 rounded-full"></div></div>';
        }

        titleEl.textContent = title;
        messageEl.textContent = message;

        toast.classList.remove('hidden');

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
    window.addEventListener('resize', function() {
        if (realtimeChart) {
            realtimeChart.resize();
        }
    });

    // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
    window.addEventListener('beforeunload', function() {
        if (socket) {
            socket.close();
        }
    });
});
</script>
{% endblock %}
